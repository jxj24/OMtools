% NFF.m: nystagmus foveation functions.%% **** NOTE: for best results, low-pass filter your position data ****% ****       at around 15--25 Hz before using these functions.    ****%%  1) Display of foveation functions:%            'showp', 'showv', 'showpv'  <-- Show the points that meet%                                             pos/vel criteria%   Usage:%   [posLimPts, velLimPts, fovLimPts] %            = nff(pos, vel, samp_freq, [posLim,velLim], 'func', dblPlot)%%     Where: dblPlot = 0 will plot position and velocity on a single graph%            dblPlot = 1 will plot position and velocity on separate graphs%   Example:%         'nff(posubary,velsubary,splfreq,[poslim,vellim],'showpv',0/1);'%          [] uses default >>Displays the number of foveation periods<<%% NOTES:%     For [posLim,velLim], to use the default limits of 0.5 degrees%        and 4.0 degrees/sec, you may simply pass an empty array ('[]').%     You must explicitly specify output arguments%        if you want access to their values.%%  2) Acuity functions:%            'nff','nffx','nffxp','nffxv'%            'naf','nafx','nafxp','nafxv'%   Usage:%   [NAFval, NAFPval, FovTime/fov period, FovTime/sec, STDpos, STDvel] %      = nff(pos, vel, samp_freq, #foveations, 'func', [tauIn posLim velLim]);%   Example:%         'nff(posubary,velubary,splfreq,#fovs,'naf(x)(p)(v)',[tauIn,posLim,velLim]);'%              [0,0,0] uses default >>Displays all NAF data<<%%  NOTES:%     Use of zero for any of [tauIn, posLim, velLim] will cause NFF to %        use that argument's CALCULATED value, while setting             %        any of [tauIn, posLim, velLim] > 0 will override any %        internally set/calculated tau, pos, vel limits. %     It is not necessary to call 'NFF' with output arguments, since the %        program will display them as they are calculated.) %%  Allowed foveation window values:  (10/13/99)  [from avg tau-plane from ARVO 1998]%  xpos = [0.5 0.75 1.0 1.25 1.5 2.0 2.5 3.0 3.5 4.0 5.0 6.0];%  yvel = [4.0 5.00 6.0 7.00 8.0 9.0 10.0];% written by:  Jonathan Jacobs%              September 1997 - July 2000 (last mod: 07/05/00)%              (based on 'NFF.AST' by LFD and NVS)function [out1, out2, out3, out4, out5, out6] ...             = nff(posArray, velArray, sampFreq, inp4, funct, inp6)global what_f_array NAFshowOutput%global fovWinPtsif nargin < 5	disp('% NFF.m: nystagmus foveation functions.   ')   disp('   ')   disp('**** NOTE: for best results, low-pass filter your position data')   disp('****       at around 15--25 Hz before using these functions.')	disp('   ')	disp('  1) Display of foveation functions:   ')	disp('            ''showp'', ''showv'', ''showpv''  <-- Show the points that meet   ')	disp('                                             pos/vel criteria   ')	disp('   Usage:   ')	disp('   [posLimPts, velLimPts, fovLimPts]    ')	disp('            = nff(pos, vel, samp_freq, [posLim,velLim], ''func'', dblPlot)   ')	disp('   Example:   ')   disp('   "nff(posubary,velsubary,splfreq,[poslim,vellim],''showpv'',0/1);"   ')   disp('   [] uses default >>Displays the number of foveation periods<<   ')	disp('   ')	disp('     Where: dblPlot = 0 will plot position and velocity on a single graph   ')	disp('            dblPlot = 1 will plot position and velocity on separate graphs   ')	disp('   ')	disp(' NOTES:   ')	disp('     For [posLim,velLim], to use the default limits of 0.5 degrees   ')	disp('        and 4.0 degrees/sec, you may simply pass an empty array (''[]'').   ')	disp('     You must explicitly specify output arguments   ')	disp('        if you want access to their values.   ')	disp('   ')	disp('  2) Acuity functions:   ')	disp('            ''nff'',''nffx'',''nffxp'',''nffxv''   ')	disp('            ''naf'',''nafx'',''nafxp'',''nafxv''   ')	disp('   Usage:   ')	disp('   [NAFval, NAFPval, FovTime/fov period, FovTime/sec, STDpos, STDvel]    ')	disp('      = nff(pos, vel, samp_freq, #foveations, ''func'', [tauIn posLim velLim]);   ')   disp('  Example:   ')   disp('  "nff(posubary,velubary,splfreq,#fovs,''naf(x)(p)(v)'',[tauIn,posLim,velLim]);"   ')   disp('       [0,0,0] uses default >>Displays all NAF data<<   ')	disp('   ')	disp('  NOTES:   ')	disp('     Use of zero for any of [tauIn, posLim, velLim] will cause NFF to    ')	disp('        use that argument''s CALCULATED value, while setting       ')         	disp('        any of [tauIn, posLim, velLim] > 0 will override any    ')	disp('        internally set/calculated tau, pos, vel limits.    ')	disp('     It is not necessary to call ''NFF'' with output arguments, since the    ')	disp('        program will display them as they are calculated.)                 ')	disp('  Allowed foveation window values:  (10/13/99)  [from avg tau-plane from ARVO 1998]  ')	disp('    xpos = [0.5 0.75 1.0 1.25 1.5 2.0 2.5 3.0 3.5 4.0 5.0 6.0];  ')	disp('    yvel = [4.0 5.00 6.0 7.00 8.0 9.0 10.0];   ')   %help nff   returnendNAFshowOutput = 1;if nargout == 6   NAFshowOutput = 0;enddblPlot = 0;  %% default is '0': individual plotsuseTauIn = 0;if nargin == 6   if strcmp(funct(1:3), 'sho')  % showp, showv showpv      dblPlot = inp6(1);    else      tauIn = inp6(1);      useTauIn = 1;   end else   inp6=0;end% can only work on one file at a time[r,c]=size(posArray);if min(r,c)>1   disp('NFF requires exactly ONE channel of data.')   disp('Use PICKDATA to select your data')   returnendfunct = lower(funct);%% default settingstau = 33.3;          %% time in msposLim = 0.5;velLim = 4.0;     %% with "lsh01_1.txt", all vels come in quanta of 2.03xxx                  %% so a lim of 4.0 cuts off the 4.06deg/sec values.  This                  %% may be fixed when I use a better tech for determining                   %% when foveation is occurring?% what were posLim and velLim?if length(inp6)>1   if isempty(inp6(2)) | inp6(2)==0       ;    else      posLim = inp6(2);   endendif length(inp6)>2   if isempty(inp6(3)) | inp6(3)==0       ;    else      velLim = inp6(3);   endend%% hardwired settings for expanded functions.  these overide any passed in.if strcmp(funct, 'nff')   % don't need anything here  elseif strcmp(funct, 'naf')   posLim = 0.5;  velLim = 4.0;  elseif strcmp(funct, 'nffx')   posLim = 2.5;  velLim = 10.0; elseif strcmp(funct, 'nffxp')   posLim = 2.5;  velLim = 4.0; elseif strcmp(funct, 'nffxv')   posLim = 0.5;  velLim = 10.0; elseif strcmp(funct, 'nafx')   % ONLY nafx can use posLim,velLim args passed in.   %tauPV = 183.8885*(1-exp(-velLim*posLim/10));  %% 168.7940   %tauPV = 250*(1-exp(-velLim*posLim/10));      %% 229.4788   %tau = 150;   %% we will insert a table lookup here.  Values in the table   %% will come from an average tau-plane generated elsewhere   %% this is ugly, and I'd like to pretend it never happened   xpos = [0.5 0.75 1.0 1.25 1.5 2.0 2.5 3.0 3.5 4.0 5.0 6.0];   yvel = [4.0 5.00 6.0 7.00 8.0 9.0 10.0];   tauPV(1,:) = [33.30 32.00 31.30 31.07 30.33 29.77 29.73 29.88 30.03 30.22 30.45 30.59];   tauPV(2,:) = [42.30 41.00 41.13 40.53 39.74 39.09 39.31 39.55 39.75 39.99 40.30 40.48];   tauPV(3,:) = [51.42 50.53 50.36 50.58 49.17 48.12 48.14 47.93 48.52 48.85 49.23 49.44];   tauPV(4,:) = [53.63 55.60 56.83 56.97 56.14 55.07 54.61 54.94 55.61 55.99 56.43 56.68];   tauPV(5,:) = [57.07 59.36 60.68 60.88 60.01 58.88 58.44 58.80 59.53 59.95 60.44 60.72];   tauPV(6,:) = [59.75 63.93 67.11 66.83 67.59 66.66 66.30 66.80 67.62 68.09 68.66 68.97];   tauPV(7,:) = [63.03 66.59 73.72 77.30 78.63 77.71 78.35 79.00 79.92 80.44 81.10 81.45];   xindex = find(xpos==posLim);   yindex = find(yvel==velLim);   tau = tauPV(yindex,xindex);   %% this is NOT a mistake.  This IS the proper order. elseif strcmp(funct, 'nafxp')   posLim = 2.5; velLim = 4.0;   tauP = 84.15*(1-exp(-posLim/0.9316));       %% 78.4009   tau = tauP; elseif strcmp(funct, 'nafxv')   posLim = 0.5; velLim = 10.0;   tauV = 1.1 + (velLim*8.1);                  %% 82.1000   tau = tauV; elseif strcmp(funct(1:3), 'sho')  % showp, showv showpv   % if we don't specity lims in 'inp4', use defaults    if ~isempty(inp4)      posLim = inp4(1); velLim = inp4(2);   end else   disp('unknown function')   returnendif useTauIn   %disp('using tauIn')   if tauIn > 0      tau = tauIn;   endend%%% from here onward, all our case-specific variables have been settotalDur  = length(posArray)/sampFreq;        % in millisecondsposLimPts = find( abs(posArray) <= posLim );  % all points in foveal extentvelLimPts = find( abs(velArray) <= velLim );  % all points that are < slip vel%% intersection of these criteria gives all points%% that fall within the foveation window.fovWinPts = find( (abs(velArray) <= velLim) & (abs(posArray) <= posLim) );if size(fovWinPts) <= 1   disp( 'Need more foveation points for analysis to be valid.')   returnendFWposArray = posArray(fovWinPts);FWvelArray = velArray(fovWinPts);fovSize   = length(fovWinPts);            %%% number of good pointsfovDur    = 1000*fovSize/sampFreq;        %%% in millisecondsfovPerSec = fovDur/totalDur;              %%% avg ms of fov per secondif ~strcmp(funct(1:3), 'sho')   fovPerCyc = fovDur/inp4;               %%% avg ms of fov per cycleend                                       %%% inp4 = # of foveations% if all we want to do is see what points satisfy our% pos/vel limits then plot them and returnif strcmp(funct(1:3), 'sho')  % showp, showv showpv   t = maket(posArray);   %t = 1:length(posArray);   % initialize the over-plotting arrays   pLimArray = NaN*ones(length(posArray),1);   vLimArray = NaN*ones(length(velArray),1);   if strcmp(funct,'showpv') | strcmp(funct,'showvp')      % then fill them with only the appropriate pts      pLimArray(fovWinPts) = posArray(fovWinPts);      vLimArray(fovWinPts) = velArray(fovWinPts);      if NAFshowOutput         if dblPlot, pv=figure;            subplot(2,1,1)          else v=figure;         end         hold on         p1 = plot(t,velArray,'y');         p2 = plot(t,vLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Velocity Points Within '...            '(±' num2str(posLim) '¡ by ±' num2str(velLim) '¡/sec)'...            ' Window for the File ' what_f_array])         drawrad(0,velLim);           if dblPlot            subplot(2,1,2)          else            p=figure;         end         hold on         p1 = plot(t,posArray,'y');         p2 = plot(t,pLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Position Points Within '...            '(±' num2str(posLim) '¡ by ±' num2str(velLim) '¡/sec)'...            ' Window for the File ' what_f_array])         drawrad(0,posLim);      end %if NAFshowOutput     elseif strcmp(funct,'showp')      % then fill them with only the appropriate pts      pLimArray(posLimPts) = posArray(posLimPts);      vLimArray(posLimPts) = velArray(posLimPts);      if NAFshowOutput         if dblPlot, pv=figure;            subplot(2,1,1)          else v=figure;         end         hold on         p1 = plot(t,velArray,'y');         p2 = plot(t,vLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Velocity Points Within Position Limit of ±'...            num2str(posLim) '¡ for the File ' what_f_array])         drawrad(0,velLim);         if dblPlot, subplot(2,1,2)          else p=figure;         end         hold on         p1 = plot(t,posArray,'y');         p2 = plot(t,pLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Position Points Within Position Limit of ±'...            num2str(posLim) '¡ for the File ' what_f_array])         drawrad(0,posLim);       end %if NAFshowOutput     elseif strcmp(funct,'showv')      % then fill them with only the appropriate pts      vLimArray(velLimPts) = velArray(velLimPts);      pLimArray(velLimPts) = posArray(velLimPts);      if NAFshowOutput         if dblPlot, pv=figure;            subplot(2,1,1)          else v=figure;         end         hold on         p1 = plot(t,velArray,'y');         p2 = plot(t,vLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Velocity Points Within Velocity Limit of ±'...            num2str(velLim) '¡/sec for the File ' what_f_array])         drawrad(0,velLim);         if dblPlot, subplot(2,1,2)          else p=figure;         end         hold on         p1 = plot(t,posArray,'y');         p2 = plot(t,pLimArray,'c');         set(p2,'LineWidth',2);         set(p2,'LineStyle','-');         set(p2,'Marker','*');         set(p2,'MarkerSize',2);         set(p2,'MarkerEdgeColor','r');         title(['Position Points Within Velocity Limit of ±'...            num2str(velLim) '¡/sec for the File ' what_f_array])         drawrad(0,posLim);      end %if NAFshowOutput   end   if NAFshowOutput      if dblPlot         figure(pv);         subplot(2,1,1);ylabel('Eye Velocity (¡/sec)');         subplot(2,1,2);xlabel('Time (sec)');         ylabel('Eye Position (¡)');       else         figure(v);xlabel('Time (sec)');         ylabel('Eye Velocity (¡/sec)');         figure(p);xlabel('Time (sec)');         ylabel('Eye Position (¡)');      end      disp(['Total time that meets position criterion = '...            num2str(1000/sampFreq*length(posLimPts)) ' msec.' ...            '    (' num2str(length(posLimPts)) ' samples) '] )      disp(['Total time that meets velocity criterion = '...            num2str(1000/sampFreq*length(velLimPts)) ' msec.' ...            '    (' num2str(length(velLimPts)) ' samples) '] )      disp(['Total time that meets both criteria      = '...             num2str(1000/sampFreq*length(fovWinPts)) ' msec.' ...            '    (' num2str(length(fovWinPts)) ' samples) '] )   end %if NAFshowOutput      % guess how many foveation periods and plot new foveation periods   if NAFshowOutput      suppress=0;    else      suppress=1;   end   [numfov,fovlist]=findfovp(fovWinPts,posArray,suppress);   pLimArray = NaN*ones(length(posArray),1);     pLimArray(fovlist) = posArray(fovlist);   if NAFshowOutput      figure         hold on      p1 = plot(t,posArray,'y');      p2 = plot(t,pLimArray,'c');      set(p2,'LineWidth',2);      set(p2,'LineStyle','-');      set(p2,'Marker','*');      set(p2,'MarkerSize',2);      set(p2,'MarkerEdgeColor','r');      drawrad(0,posLim);      ept      title(['File: ' what_f_array '  ' num2str(numfov) ' '...             ' Foveation Periods Identified by Algorithm Within '...              '(±' num2str(posLim) '¡ by ±' num2str(velLim) '¡/sec) Window'])   end %if NAFshowOutput   % set our output variables   out1 = posLimPts;   out2 = velLimPts;   out3 = fovWinPts;   out4 = numfov;   out5 = fovlist;       returnend% start calculations for common NAF/NFX functionsSTDpos = std(FWposArray);STDvel = std(FWvelArray);%% for NAFnormfac = 0.5/posLim;            %% normalized to standardposfac  = (posLim/velLim);       %% limits%posfac  = (posLim/velLim)^2;VARpos = STDpos^2;VARvel = STDvel^2;pooledVar = 0.5*( (STDpos)^2 + (STDvel*(posLim/velLim))^2 );pooledSTD = sqrt(pooledVar);% check to see if enough foveation for realistic resultsif fovPerSec <= 2000/sampFreq	disp('Insufficient foveation time for reasonable analysis.')	yn=lower(input('Be unreasonable and override anyway (y/n)? ','s')); 	if yn~='y'	   fovFlag = 0;	   return	endendNFFval  = fovPerSec/(1000*STDpos * STDvel); %% sec/deg^2 (w/o the 1000, ansNFFPval = fovPerSec/(1000*STDpos);          %% sec/deg   (would be in msecNAFval  = (1-(pooledSTD*normfac)) * (1 - exp(-fovPerCyc/tau));NAFPval =   (1-(STDpos*normfac))  * (1 - exp(-fovPerCyc/tau));if (NAFshowOutput)      %% add a condition for suppression of printout.   disp(' ')   disp([upper(funct) ' results:'])   if strcmp(lower(funct(1:3)),'nff')      disp(['                          NFF = ' num2str(NFFval) ' sec/deg^2'])      disp(['      NFF (for position only) = ' num2str(NFFPval) ' sec/deg'])      disp(['    Foveation time per second = ' num2str(fovPerSec/1000) ' sec'])      disp(['     Foveation time per cycle = ' num2str(fovPerCyc) ' msec'])      disp(['   Foveation window (position): ' num2str(posLim) ' deg'])      disp(['   Foveation window (velocity): ' num2str(velLim) ' deg/sec'])    elseif strcmp(lower(funct(1:3)),'naf')      snel = va2naf(2,NAFval,1);      if isnan(snel), snel = '20/1,250,000';end      disp(['                       NAF(X) = ' num2str(NAFval) '  (<= ' snel ')'])      disp(['   NAF(X) (for position only) = ' num2str(NAFPval) ' deg'])      disp(['Foveation time per fov period = ' num2str(fovPerCyc) ' msec'])      disp(['    Foveation time per second = ' num2str(fovPerSec/1000) ' sec'])      disp(['                     STD(pos) = ' num2str(STDpos) ' deg'])      disp(['                     STD(vel) = ' num2str(STDvel) ' deg/sec'])      disp(['   Foveation window (position): ' num2str(posLim) ' deg'])      disp(['   Foveation window (velocity): ' num2str(velLim) ' deg/sec'])      disp(['                           tau: ' num2str(tau) ' msec'])   endend% set our output variablesout1 = NAFval;out2 = NAFPval;out3 = fovPerCyc;out4 = fovPerSec;out5 = STDpos;out6 = STDvel;%keyboard